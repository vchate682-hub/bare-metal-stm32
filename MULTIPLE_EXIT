#include <stdint.h>
/******************************************************************************/
/*                                                                            */
/*                                        */
/*                                                                            */
/******************************************************************************/
/******************  Bits definition for GPIO register  *****************/

#define EXTI_BASE 0x40013C00UL
#define RCC_BASE    0x40023800UL
#define RCC         ((RCC_TypeDef *)  RCC_BASE)
#define AHB1PERIPH_BASE       0x40020000UL
#define GPIOB_BASE            (AHB1PERIPH_BASE + 0x0400UL) // 0x40020400
#define GPIOC_BASE            (AHB1PERIPH_BASE + 0x0800UL) // 0x40020800
#define EXTI_BASE             0x40013C00UL
#define EXTI                  ((EXTI_TypeDef *) EXTI_BASE)
#define GPIOB      ((GPIO_TypeDef *) GPIOB_BASE)
#define GPIOC      ((GPIO_TypeDef *) GPIOC_BASE)
#define BSRR_SET(pin)   (1U << (pin))
#define BSRR_RESET(pin) (1U << ((pin)+16))
#define NVIC_ISER0 (*(volatile uint32_t*)0xE000E100)


/*******************  Bit definition for EXTI_IMR register  *******************/
#define EXTI_IMR_MR0_Pos          (0U)
#define EXTI_IMR_MR0_Msk          (0x1UL << EXTI_IMR_MR0_Pos)                   /*!< 0x00000001 */
#define EXTI_IMR_MR0              EXTI_IMR_MR0_Msk                             /*!< Interrupt Mask on line 0 */
#define EXTI_IMR_MR1_Pos          (1U)
#define EXTI_IMR_MR1_Msk          (0x1UL << EXTI_IMR_MR1_Pos)                   /*!< 0x00000002 */
#define EXTI_IMR_MR1              EXTI_IMR_MR1_Msk                             /*!< Interrupt Mask on line 1 */
#define EXTI_IMR_MR2_Pos          (2U)
#define EXTI_IMR_MR2_Msk          (0x1UL << EXTI_IMR_MR2_Pos)                   /*!< 0x00000004 */
#define EXTI_IMR_MR2              EXTI_IMR_MR2_Msk                             /*!< Interrupt Mask on line 2 */
#define EXTI_IMR_MR3_Pos          (3U)
#define EXTI_IMR_MR3_Msk          (0x1UL << EXTI_IMR_MR3_Pos)                   /*!< 0x00000008 */
#define EXTI_IMR_MR3              EXTI_IMR_MR3_Msk                             /*!< Interrupt Mask on line 3 */
#define EXTI_IMR_MR4_Pos          (4U)
#define EXTI_IMR_MR4_Msk          (0x1UL << EXTI_IMR_MR4_Pos)                   /*!< 0x00000010 */
#define EXTI_IMR_MR4              EXTI_IMR_MR4_Msk                             /*!< Interrupt Mask on line 4 */
/* Reference Defines */
#define  EXTI_IMR_IM0                        EXTI_IMR_MR0
#define  EXTI_IMR_IM1                        EXTI_IMR_MR1
#define  EXTI_IMR_IM2                        EXTI_IMR_MR2
#define  EXTI_IMR_IM3                        EXTI_IMR_MR3
#define  EXTI_IMR_IM4                        EXTI_IMR_MR4
/*******************  Bit definition for EXTI_EMR register  *******************/
#define EXTI_EMR_MR0_Pos          (0U)
#define EXTI_EMR_MR0_Msk          (0x1UL << EXTI_EMR_MR0_Pos)                   /*!< 0x00000001 */
#define EXTI_EMR_MR0              EXTI_EMR_MR0_Msk                             /*!< Event Mask on line 0 */
#define EXTI_EMR_MR1_Pos          (1U)
#define EXTI_EMR_MR1_Msk          (0x1UL << EXTI_EMR_MR1_Pos)                   /*!< 0x00000002 */
#define EXTI_EMR_MR1              EXTI_EMR_MR1_Msk                             /*!< Event Mask on line 1 */
#define EXTI_EMR_MR2_Pos          (2U)
#define EXTI_EMR_MR2_Msk          (0x1UL << EXTI_EMR_MR2_Pos)                   /*!< 0x00000004 */
#define EXTI_EMR_MR2              EXTI_EMR_MR2_Msk                             /*!< Event Mask on line 2 */
#define EXTI_EMR_MR3_Pos          (3U)
#define EXTI_EMR_MR3_Msk          (0x1UL << EXTI_EMR_MR3_Pos)                   /*!< 0x00000008 */
#define EXTI_EMR_MR3              EXTI_EMR_MR3_Msk                             /*!< Event Mask on line 3 */
#define EXTI_EMR_MR4_Pos          (4U)
#define EXTI_EMR_MR4_Msk          (0x1UL << EXTI_EMR_MR4_Pos)                   /*!< 0x00000010 */
#define EXTI_EMR_MR4              EXTI_EMR_MR4_Msk                             /*!< Event Mask on line 4 */
/* Reference Defines */
#define  EXTI_EMR_EM0                        EXTI_EMR_MR0
#define  EXTI_EMR_EM1                        EXTI_EMR_MR1
#define  EXTI_EMR_EM2                        EXTI_EMR_MR2
#define  EXTI_EMR_EM3                        EXTI_EMR_MR3
#define  EXTI_EMR_EM4                        EXTI_EMR_MR4
/******************  Bit definition for EXTI_RTSR register  *******************/
#define EXTI_RTSR_TR0_Pos         (0U)
#define EXTI_RTSR_TR0_Msk         (0x1UL << EXTI_RTSR_TR0_Pos)                  /*!< 0x00000001 */
#define EXTI_RTSR_TR0             EXTI_RTSR_TR0_Msk                            /*!< Rising trigger event configuration bit of line 0 */
#define EXTI_RTSR_TR1_Pos         (1U)
#define EXTI_RTSR_TR1_Msk         (0x1UL << EXTI_RTSR_TR1_Pos)                  /*!< 0x00000002 */
#define EXTI_RTSR_TR1             EXTI_RTSR_TR1_Msk                            /*!< Rising trigger event configuration bit of line 1 */
#define EXTI_RTSR_TR2_Pos         (2U)
#define EXTI_RTSR_TR2_Msk         (0x1UL << EXTI_RTSR_TR2_Pos)                  /*!< 0x00000004 */
#define EXTI_RTSR_TR2             EXTI_RTSR_TR2_Msk                            /*!< Rising trigger event configuration bit of line 2 */
#define EXTI_RTSR_TR3_Pos         (3U)
#define EXTI_RTSR_TR3_Msk         (0x1UL << EXTI_RTSR_TR3_Pos)                  /*!< 0x00000008 */
#define EXTI_RTSR_TR3             EXTI_RTSR_TR3_Msk                            /*!< Rising trigger event configuration bit of line 3 */
#define EXTI_RTSR_TR4_Pos         (4U)
#define EXTI_RTSR_TR4_Msk         (0x1UL << EXTI_RTSR_TR4_Pos)                  /*!< 0x00000010 */
#define EXTI_RTSR_TR4             EXTI_RTSR_TR4_Msk                            /*!< Rising trigger event configuration bit of line 4 */

/******************  Bit definition for EXTI_FTSR register  *******************/
#define EXTI_FTSR_TR0_Pos         (0U)
#define EXTI_FTSR_TR0_Msk         (0x1UL << EXTI_FTSR_TR0_Pos)                  /*!< 0x00000001 */
#define EXTI_FTSR_TR0             EXTI_FTSR_TR0_Msk                            /*!< Falling trigger event configuration bit of line 0 */
#define EXTI_FTSR_TR1_Pos         (1U)
#define EXTI_FTSR_TR1_Msk         (0x1UL << EXTI_FTSR_TR1_Pos)                  /*!< 0x00000002 */
#define EXTI_FTSR_TR1             EXTI_FTSR_TR1_Msk                            /*!< Falling trigger event configuration bit of line 1 */
#define EXTI_FTSR_TR2_Pos         (2U)
#define EXTI_FTSR_TR2_Msk         (0x1UL << EXTI_FTSR_TR2_Pos)                  /*!< 0x00000004 */
#define EXTI_FTSR_TR2             EXTI_FTSR_TR2_Msk                            /*!< Falling trigger event configuration bit of line 2 */
#define EXTI_FTSR_TR3_Pos         (3U)
#define EXTI_FTSR_TR3_Msk         (0x1UL << EXTI_FTSR_TR3_Pos)                  /*!< 0x00000008 */
#define EXTI_FTSR_TR3             EXTI_FTSR_TR3_Msk                            /*!< Falling trigger event configuration bit of line 3 */
#define EXTI_FTSR_TR4_Pos         (4U)
#define EXTI_FTSR_TR4_Msk         (0x1UL << EXTI_FTSR_TR4_Pos)                  /*!< 0x00000010 */
#define EXTI_FTSR_TR4             EXTI_FTSR_TR4_Msk                            /*!< Falling trigger event configuration bit of line 4 */
/******************  Bit definition for EXTI_SWIER register  ******************/
#define EXTI_SWIER_SWIER0_Pos     (0U)
#define EXTI_SWIER_SWIER0_Msk     (0x1UL << EXTI_SWIER_SWIER0_Pos)              /*!< 0x00000001 */
#define EXTI_SWIER_SWIER0         EXTI_SWIER_SWIER0_Msk                        /*!< Software Interrupt on line 0 */
#define EXTI_SWIER_SWIER1_Pos     (1U)
#define EXTI_SWIER_SWIER1_Msk     (0x1UL << EXTI_SWIER_SWIER1_Pos)              /*!< 0x00000002 */
#define EXTI_SWIER_SWIER1         EXTI_SWIER_SWIER1_Msk                        /*!< Software Interrupt on line 1 */
#define EXTI_SWIER_SWIER2_Pos     (2U)
#define EXTI_SWIER_SWIER2_Msk     (0x1UL << EXTI_SWIER_SWIER2_Pos)              /*!< 0x00000004 */
#define EXTI_SWIER_SWIER2         EXTI_SWIER_SWIER2_Msk                        /*!< Software Interrupt on line 2 */
#define EXTI_SWIER_SWIER3_Pos     (3U)
#define EXTI_SWIER_SWIER3_Msk     (0x1UL << EXTI_SWIER_SWIER3_Pos)              /*!< 0x00000008 */
#define EXTI_SWIER_SWIER3         EXTI_SWIER_SWIER3_Msk                        /*!< Software Interrupt on line 3 */
#define EXTI_SWIER_SWIER4_Pos     (4U)
#define EXTI_SWIER_SWIER4_Msk     (0x1UL << EXTI_SWIER_SWIER4_Pos)              /*!< 0x00000010 */
#define EXTI_SWIER_SWIER4         EXTI_SWIER_SWIER4_Msk                        /*!< Software Interrupt on line 4 */
/*******************  Bit definition for EXTI_PR register  ********************/
#define EXTI_PR_PR0_Pos           (0U)
#define EXTI_PR_PR0_Msk           (0x1UL << EXTI_PR_PR0_Pos)                    /*!< 0x00000001 */
#define EXTI_PR_PR0               EXTI_PR_PR0_Msk                              /*!< Pending bit for line 0 */
#define EXTI_PR_PR1_Pos           (1U)
#define EXTI_PR_PR1_Msk           (0x1UL << EXTI_PR_PR1_Pos)                    /*!< 0x00000002 */
#define EXTI_PR_PR1               EXTI_PR_PR1_Msk                              /*!< Pending bit for line 1 */
#define EXTI_PR_PR2_Pos           (2U)
#define EXTI_PR_PR2_Msk           (0x1UL << EXTI_PR_PR2_Pos)                    /*!< 0x00000004 */
#define EXTI_PR_PR2               EXTI_PR_PR2_Msk                              /*!< Pending bit for line 2 */
#define EXTI_PR_PR3_Pos           (3U)
#define EXTI_PR_PR3_Msk           (0x1UL << EXTI_PR_PR3_Pos)                    /*!< 0x00000008 */
#define EXTI_PR_PR3               EXTI_PR_PR3_Msk                              /*!< Pending bit for line 3 */
#define EXTI_PR_PR4_Pos           (4U)
#define EXTI_PR_PR4_Msk           (0x1UL << EXTI_PR_PR4_Pos)                    /*!< 0x00000010 */
#define EXTI_PR_PR4               EXTI_PR_PR4_Msk                              /*!< Pending bit for line 4 */
/******************************************************************************/
/*                                                                            */
/*                    STRUCTURE DECLARTION WITH ENUM AND POINTER FUNCTION                      */
/*                                                                            */
/******************************************************************************/
/**
  * @brief External Interrupt/Event Controller
  */
typedef struct {
    volatile uint32_t MODER;
    volatile uint32_t OTYPER;
    volatile uint32_t OSPEEDR;
    volatile uint32_t PUPDR;
    volatile uint32_t IDR;
    volatile uint32_t ODR;
    volatile uint32_t BSRR;
    volatile uint32_t LCKR;
    volatile uint32_t AFRL;
    volatile uint32_t AFRH;
} GPIO_TypeDef;

/**
  * @brief System clock
  */

typedef struct {
    volatile uint32_t CR;            // 0x00
    volatile uint32_t PLLCFGR;       // 0x04
    volatile uint32_t CFGR;          // 0x08
    volatile uint32_t CIR;           // 0x0C
    volatile uint32_t AHB1RSTR;      // 0x10
    volatile uint32_t AHB2RSTR;      // 0x14
    volatile uint32_t AHB3RSTR;      // 0x18
    uint32_t          RESERVED0;     // 0x1C
    volatile uint32_t APB1RSTR;      // 0x20
    volatile uint32_t APB2RSTR;      // 0x24
    uint32_t          RESERVED1[2];  // 0x28
    volatile uint32_t AHB1ENR;       // 0x30
    volatile uint32_t AHB2ENR;       // 0x34
    uint32_t          RESERVED2[2];  // 0x38
    volatile uint32_t APB1ENR;       // 0x40
    volatile uint32_t APB2ENR;       // 0x44  <-- Needed for SYSCFG
} RCC_TypeDef;



/**
  * @brief External Interrupt/Event Controller
  */

typedef struct
{
 volatile uint32_t IMR;
 volatile uint32_t EMR;
 volatile uint32_t RTSR;
 volatile uint32_t FTSR;
 volatile uint32_t SWIER;
 volatile uint32_t PR;
} EXTI_TypeDef;
#define EXTI ((EXTI_TypeDef *) EXTI_BASE)
#define SYSCFG_BASE 0x40013800UL
#define SYSCFG ((SYSCFG_TypeDef*)SYSCFG_BASE)

typedef struct {
 volatile uint32_t MEMRMP;
 volatile uint32_t PMC;
 volatile uint32_t EXTICR[4];
} SYSCFG_TypeDef;

typedef enum{
  EXTI0_IRQn                  = 6,      /*!< EXTI Line0 Interrupt                                              */
  EXTI1_IRQn                  = 7,      /*!< EXTI Line1 Interrupt                                              */
  EXTI2_IRQn                  = 8,      /*!< EXTI Line2 Interrupt                                              */
  EXTI3_IRQn                  = 9,      /*!< EXTI Line3 Interrupt                                              */
  EXTI4_IRQn                  = 10,     /*!< EXTI Line4 Interrupt                                              */
} IRQn_Type;

/**
  * @brief GPIO OUTPUT/INPUT
  */
typedef enum
{
    GPIO_MODE_INPUT  = 0x00,
    GPIO_MODE_OUTPUT = 0x01
} GPIO_Mode_t;


/**
  * @brief   CHECKING FLAG IN ISR
  */
volatile uint32_t event_flags = 0;
typedef enum
{
    EVT_BTN1 = (1 << 0),
    EVT_BTN2 = (1 << 1),
    EVT_BTN3  = (1 << 2),
	EVT_BTN4  = (1 << 3)
} EventFlags;


/******************************************************************************/
/*                                                                            */
/*                            General Purpose I/O  FUNCTION                            */
/*                                                                            */
/******************************************************************************/
//* @brief  Set the new I/P configuration
void GPIO_SetMode(GPIO_TypeDef *GPIOx, uint8_t pin, GPIO_Mode_t mode)
{
    GPIOx->MODER &= ~(0x3UL << (pin * 2));
    GPIOx->MODER |= ((uint32_t)mode << (pin * 2));
}
// * @brief Set the new pull-up/pull-down configuration
void GPIO_SetPull(GPIO_TypeDef *GPIOx, uint8_t pin, uint8_t pupd)
{
    GPIOx->PUPDR &= ~(0x3UL << (pin * 2));
    GPIOx->PUPDR |= ((uint32_t)pupd << (pin * 2));
}
// * @brief Writes a logic level to a specific GPIO pin using the ODR register.
void GPIO_WritePin(GPIO_TypeDef *GPIOx, uint8_t pin, uint8_t state)
{
    if (state)
    {
        GPIOx->ODR |= (1UL << pin);
    }
    else
    {
        GPIOx->ODR &= ~(1UL << pin);
    }
}
// * @brief Writes a logic level to a specific GPIO pin using the BSRR register.
void GPIO_WritePin_Atomic(GPIO_TypeDef *GPIOx, uint8_t pin, uint8_t state)
{
    if (state != 0)
    {
        GPIOx->BSRR = (1UL << pin);
    }
    else
    {
        GPIOx->BSRR = (1UL << (pin + 16));
    }
}
// * @brief Writes a logic level to a specific GPIO pin using the  register.
void GPIO_SetSpeed(GPIO_TypeDef *GPIOx, uint8_t pin, uint8_t speed)
{
    GPIOx->OSPEEDR &= ~(0x3UL << (pin * 2));
    GPIOx->OSPEEDR |= ((uint32_t)speed << (pin * 2));
}
// * @brief Writes a logic level to a specific GPIO pin using the ODR register.
uint8_t GPIO_LockPin(GPIO_TypeDef *GPIOx, uint8_t pin)
{
    uint32_t temp = (1UL << 16) | (1UL << pin);
    GPIOx->LCKR = temp;
    GPIOx->LCKR = (1UL << pin);
    GPIOx->LCKR = temp;
    temp = GPIOx->LCKR;
    return (GPIOx->LCKR & (1UL << 16)) ? 1 : 0;
}
// * @brief Writes a logic level to a specific GPIO pin using the ODR register.
uint8_t GPIO_ReadPin(GPIO_TypeDef *GPIOx, uint8_t pin)
{

    if ((GPIOx->IDR & (1UL << pin)) != 0)
    {
        return 1;
    }
    return 0;
}
// * @brief Writes a logic level to a specific GPIO pin using the ODR register.
void GPIO_SetType(GPIO_TypeDef *GPIOx, uint8_t pin, uint8_t type)
{
    if (type)
    {
        GPIOx->OTYPER |= (1UL << pin);
    } else
    {
        GPIOx->OTYPER &= ~(1UL << pin);
    }
}
/******************************************************************************/
/*                                                                            */
/*                    ISR FUNCTION
/*                                                                            */
/******************************************************************************/
// * @brief Writes a logic level to a specific EXIT0 ISR.
void EXTI0_IRQHandler(void)
{
    if(EXTI->PR & (1<<0))
    {
        EXTI->PR = (1<<0);
        event_flags |= EVT_BTN1;
    }
}
// * @brief Writes a logic level to a specific EXIT1 ISR.

void EXTI1_IRQHandler(void)
{
    if(EXTI->PR & (1<<1))
    { EXTI->PR = (1<<1);
        event_flags |= EVT_BTN2;
    }
}
// * @brief Writes a logic level to a specific EXIT2 ISR.

void EXTI2_IRQHandler(void)
{
    if(EXTI->PR & (1<<2))
    {
        EXTI->PR = (1<<2);
        event_flags |= EVT_BTN3;
    }
}
// * @brief Writes a logic level to a specific EXIT3 ISR.

void EXTI3_IRQHandler(void)
{
    if(EXTI->PR & (1<<3))
    {
        EXTI->PR = (1<<3);
        event_flags |= EVT_BTN4;
    }
}
/******************************************************************************/
/*                                                                            */
/*                    MAIN  FUNCTION
/*                                                                            */
/******************************************************************************/
int main()
{

	 RCC->AHB1ENR |= (1 << 1) | (1 << 2);
	    RCC->APB2ENR |= (1 << 14);
	    GPIO_SetMode(GPIOB,0,GPIO_MODE_INPUT);
	    GPIO_SetMode(GPIOB,1,GPIO_MODE_INPUT);
	    GPIO_SetMode(GPIOB,2,GPIO_MODE_INPUT);
	    GPIO_SetMode(GPIOB,3,GPIO_MODE_INPUT);
	    GPIO_SetPull(GPIOB,0,1);
	    GPIO_SetPull(GPIOB,1,1);
	    GPIO_SetPull(GPIOB,2,1);
	    GPIO_SetPull(GPIOB,3,1);
	    GPIO_SetMode(GPIOC,10,GPIO_MODE_OUTPUT);
	    GPIO_SetMode(GPIOC,11,GPIO_MODE_OUTPUT);
	    GPIO_SetMode(GPIOC,12,GPIO_MODE_OUTPUT);
	    GPIO_SetMode(GPIOC,13,GPIO_MODE_OUTPUT);

	   SYSCFG->EXTICR[0] &= ~(0xFFFF << 0);
	   SYSCFG->EXTICR[0] = (1<<0) | (1<<4) | (1<<8) | (1<<12);

	    EXTI->IMR  |= (EXTI_IMR_MR0|EXTI_IMR_MR1|EXTI_IMR_MR2|EXTI_IMR_MR3);
	    EXTI->FTSR |= (EXTI_FTSR_TR0|EXTI_FTSR_TR1|EXTI_FTSR_TR2|EXTI_FTSR_TR3);
	    EXTI->PR = EXTI_PR_PR0| EXTI_PR_PR1 |  EXTI_PR_PR2 | EXTI_PR_PR3;
	    NVIC_ISER0 |= (1<<6)|(1<<7)|(1<<8)|(1<<9);


		 while(1)
		 {
		     if(event_flags & EVT_BTN1)
		     {
		         event_flags &= ~EVT_BTN1;
		         GPIOC->BSRR = BSRR_SET(10);
		    	 for(volatile int i = 0; i < 1000; i++);

		         	GPIOC->BSRR = BSRR_RESET(10);
		     }
		     if(event_flags & EVT_BTN2)
		     		     {
		     		         event_flags &= ~EVT_BTN2;
		     		        GPIOC->BSRR = BSRR_SET(11);
		     		  	 for(volatile int i = 0; i <1000; i++);

		     		        	GPIOC->BSRR = BSRR_RESET(11);
		     		     }
		     if(event_flags & EVT_BTN3)
		     		     {
		     		         event_flags &= ~EVT_BTN3;
		     		        GPIOC->BSRR = BSRR_SET(12);
		     		  	 for(volatile int i = 0; i < 1000; i++);

		     		        	GPIOC->BSRR = BSRR_RESET(12);
		     		     }
		     if(event_flags & EVT_BTN4)
		     		     {
		     		         event_flags &= ~EVT_BTN4;
		     		        GPIOC->BSRR = BSRR_SET(13);
		     		  	 for(volatile int i = 0; i < 1000; i++);

		     		        	GPIOC->BSRR = BSRR_RESET(13);

		     		     }
		 }

}
